#!/usr/bin/expect -f

# Generated by Chef for <%= node['fqdn'] %>
#
# Any local changes will be deleted.
#

# unattended install/upgrade of the controller

# installer defaults
<% # Not sure when the default install path changed, we noticed it going from 3.4.2 to 3.5.5
if node['appdynamics']['controller']['version'] == '3.4.2' %>
set DEFAULT_INSTALLATION_LOCATION "/home/appdynamics/appdynamics-controller"
<% else %>
set DEFAULT_INSTALLATION_LOCATION "/home/appdynamics/AppDynamics/Controller"
<% end %>

set INSTALLATION_LOCATION "<%=node['appdynamics']['controller']['install_dir']%>"

set DEFAULT_APPSERVER_PORT "8090"
set APPSERVER_PORT "<%=node['appdynamics']['controller']['appserver_port']%>"

set DEFAULT_DATABASE_PORT "3388"
set DATABASE_PORT "<%=node['appdynamics']['controller']['database_port']%>"

set DEFAULT_ADMIN_PORT "4848"
set ADMIN_PORT "<%=node['appdynamics']['controller']['admin_port']%>"

set DEFAULT_JMS_PORT "7676"
set JMS_PORT "<%=node['appdynamics']['controller']['jms_port']%>"

set DEFAULT_IIOP_PORT "3700"
set IIOP_PORT "<%=node['appdynamics']['controller']['iiop_port']%>"

set DEFAULT_SSL_PORT "8181"
set SSL_PORT "<%=node['appdynamics']['controller']['ssl_port']%>"


spawn "/home/appdynamics/controller_32bit_linux-<%=node['appdynamics']['controller']['version']%>.sh"
# the upgrade process can take some time while it stops and restarts services
set timeout 600

expect {
  # Install the controller?
  "OK \\\[o, Enter\\\], Cancel \\\[c\\\]\r\n$" {
    send "o\r"
    exp_continue
  }
  # agreeing to the Java EULA
  # installation directory already exists
  "Yes \\\[1\\\], No \\\[2\\\]\r\n$" {
    send "1\r"
    exp_continue
  }
  # installation location
  -re "\\\[$DEFAULT_INSTALLATION_LOCATION|$INSTALLATION_LOCATION\\\]\r\n$" {
    send "$INSTALLATION_LOCATION\r"
    exp_continue
  }
  # hostname
  -re "\\\[<%=node['hostname']%>.*\\\]\r\n$" {
    send -- "<%=node['fqdn']%>\r"
    exp_continue
  }
  # Allow the appdyamic to collect information
  -re "Do we have your consent to collect usage information?" {
  send "y\n"
  exp_continue
  }
  # appserver port
  -re "\\\[$DEFAULT_APPSERVER_PORT|$APPSERVER_PORT\\\]\r\n$" {
    send "$APPSERVER_PORT\r"
    exp_continue
  }
  # database port
  -re "\\\[$DEFAULT_DATABASE_PORT|$DATABASE_PORT\\\]\r\n$" {
    send "$DATABASE_PORT\r"
    exp_continue
  }
  # appserver admin port
  -re "\\\[$DEFAULT_ADMIN_PORT|$ADMIN_PORT\\\]\r\n$" {
    send "$ADMIN_PORT\r"
    exp_continue
  }
  # appserver JMS port
  -re "\\\[$DEFAULT_JMS_PORT|$JMS_PORT\\\]\r\n$" {
    send "$JMS_PORT\r"
    exp_continue
  }
  # appserver IIOP port
  -re "\\\[$DEFAULT_IIOP_PORT|$IIOP_PORT\\\]\r\n$" {
    send "$IIOP_PORT\r"
    exp_continue
  }
  # appserver SSL port
  -re "\\\[$DEFAULT_SSL_PORT|$SSL_PORT\\\]\r\n$" {
    send "$SSL_PORT\r"
    exp_continue
  }
  # tenancy mode
  "Single Tenancy Mode \\\[1, Enter\\\], Multi Tenancy Mode \\\[2\\\]\r\n$" {
    send "<%=node['appdynamics']['controller']['tenancy_mode']%>\n"
    exp_continue
  }
  # controller root user password
   -re "Controller root User's Password\r\n$" {
    send "<%=node['appdynamics']['controller']['root_password']%>\n"
    exp_continue
  }
  # verify controller root user password
   -re "Verify Controller root User's Password\r\n$" {
   send "<%=node['appdynamics']['controller']['root_password']%>\n" 
   exp_continue
  }
   # admin username
  "User Name\r\n$" {
    send "<%=node['appdynamics']['controller']['admin_user']%>\n"
    exp_continue
  }
  # admin password
  "Password\r\n$" {
    send "<%=node['appdynamics']['controller']['admin_password']%>\n"
    exp_continue
  }
  # admin password confirmation
  "Verify Password\r\n$" {
    send "<%=node['appdynamics']['controller']['admin_password']%>\n"
    exp_continue
  }
  # AppDynamics profile
  "to install this profile) \\\[5\\\]\r\n$" {
    send "<%=node['appdynamics']['controller']['install_profile']%>\r"
    exp_continue
  }
  # HA mode
  "Not Applicable (Not HA Enabled) \\\[1, Enter\\\], HA Primary Controller \\\[2\\\], HA Secondary Controller \\\[3\\\]\r\n$" {
    send "<%=node['appdynamics']['controller']['ha_mode']%>\r"
    exp_continue
  }
  "\\\[Enter\\\]\r\n$" {
    send "\r"
    exp_continue
  }
  # For Installation of Demo mode
    "Demo (Supports up to 5 nodes assigned to at most 2 applications. Not recommended for production use) \\\[1\\\], Small (Supports up to 10 nodes assigned to at most 4 applications) \\\[2\\\]\r\n$" {
   send "1\r"
   exp_continue
   }
    # hostname
  -re "\\\[.*\\\]\r\n$" {
   send -- "\r"
   exp_continue
   }
  eof {
    puts "all done"
  }
}
